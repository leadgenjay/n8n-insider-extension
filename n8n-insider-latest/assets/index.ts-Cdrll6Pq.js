chrome.action.onClicked.addListener(e=>{e.id&&chrome.sidePanel.open({tabId:e.id})});chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(e=>console.error("Failed to set panel behavior:",e));chrome.runtime.onMessage.addListener((e,t,r)=>{switch(e.type){case"CAPTURE_SCREENSHOT":return c().then(r),!0;case"GET_CURRENT_URL":return chrome.tabs.query({active:!0,currentWindow:!0},n=>{r({url:n[0]?.url||null})}),!0;case"INJECT_CONTENT_SCRIPT":return o(e.tabId).then(r),!0;default:console.log("Unknown message type:",e.type)}});async function c(){try{console.log("[n8n-copilot-bg] Starting screenshot capture...");const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(console.log("[n8n-copilot-bg] Active tab:",e?.id,e?.url),!e.id)return console.error("[n8n-copilot-bg] No active tab found"),{success:!1,error:"No active tab found"};console.log("[n8n-copilot-bg] Calling captureVisibleTab...");const t=await chrome.tabs.captureVisibleTab({format:"png",quality:90});return console.log("[n8n-copilot-bg] Screenshot captured, size:",t?.length||0),{success:!0,screenshot:t}}catch(e){return console.error("[n8n-copilot-bg] Screenshot capture error:",e),{success:!1,error:String(e)}}}async function o(e){try{return await chrome.scripting.executeScript({target:{tabId:e},files:["src/content/index.ts"]}),{success:!0}}catch(t){return{success:!1,error:String(t)}}}chrome.runtime.onInstalled.addListener(()=>{console.log("N8N Insider installed")});chrome.tabs.onUpdated.addListener((e,t,r)=>{t.url&&chrome.runtime.sendMessage({type:"URL_CHANGED",url:t.url,tabId:e}).catch(()=>{})});chrome.tabs.onActivated.addListener(async e=>{try{const t=await chrome.tabs.get(e.tabId);chrome.runtime.sendMessage({type:"TAB_CHANGED",url:t.url,tabId:e.tabId}).catch(()=>{})}catch{}});
